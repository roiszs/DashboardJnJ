<!-- static/add.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Agregar Eficiencia</title>
  <!-- Enlaza el CSS que montas en /static -->
  <link rel="stylesheet" href="/static/style.css" />
   <!-- Tailwind Play CDN + configuración de colores y tipografía -->
<!-- Tailwind + tu paleta J&J -->
<script>
   if (!localStorage.getItem('token')) {
    window.location.href = '/login.html';
  }
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          'jj-red':   '#8A0000',
          'jj-light': '#FFFFFF'
        },
        fontFamily: {
          sans: ['Source Sans Pro','ui-sans-serif','system-ui']
        }
      }
    }
  }
</script>
<script src="https://cdn.tailwindcss.com"></script>

</head>
<body class="bg-jj-red font-sans overflow-auto">
  <div class="min-h-screen flex flex-col items-center justify-start py-8 px-4">
    <!-- Logo J&J -->
    <div class="mb-8">
      <img src="/static/images/JnJ.png" alt="JJ" class="h-16" />
    </div>
    
<!-- Dashboard -->
    <div class="w-full max-w-4xl flex justify-end mb-6">
      <a href="/"
         class="bg-red-600 text-white font-semibold rounded px-4 py-2 hover:bg-green-600 transition-colors duration-200">
        <!-- Icono (opcional) -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10 2a1 1 0 011 1v6h6a1 1 0 110 2h-6v6a1 1 0 11-2 0v-6H3a1 1 0 010-2h6V3a1 1 0 011-1z"/>
        </svg>
        Ver Dashboard
      </a>
    </div>
    

    <!-- Formulario -->
    <form id="efForm"
          class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl">
      <div>
        <label class="block text-jj-light font-bold mb-1">
          Nombre del Asociado
        </label>
        <input name="nombre_asociado" required
               class="w-full bg-jj-light text-black rounded-md px-3 py-2 focus:outline-none"/>
      </div>
      <div>
        <label class="block text-jj-light font-bold mb-1">Línea</label>
        <input name="linea" required placeholder="p.ej. L27"
               class="w-full bg-jj-light text-black rounded-md px-3 py-2 focus:outline-none"/>
      </div>

      <div>
        <label class="block text-jj-light font-bold mb-1">Supervisor</label>
        <input name="supervisor" required
               class="w-full bg-jj-light text-black rounded-md px-3 py-2 focus:outline-none"/>
      </div>
      <div>
        <label class="block text-jj-light font-bold mb-1">Tipo de Proceso</label>
        <select name="tipo_proceso" required
                class="w-full bg-jj-light text-black rounded-md px-3 py-2 focus:outline-none">
          <option value="">-- seleccionar --</option>
          <option value="SW">SW</option>
          <option value="WD">WD</option>
        </select>
      </div>

      <div class="md:col-span-2">
        <label class="block text-jj-light font-bold mb-1">
          Proceso (descripción)
        </label>
        <input name="proceso" required
               class="w-full bg-jj-light text-black rounded-md px-3 py-2 focus:outline-none"/>
      </div>

      <div>
        <label class="block text-jj-light font-bold mb-1">
          Eficiencia del Asociado (%)
        </label>
        <input name="eficiencia_asociado" type="number" step="0.1" required
               class="w-full bg-jj-light text-black rounded-md px-3 py-2 focus:outline-none"/>
      </div>
      <div>
        <label class="block text-jj-light font-bold mb-1">
          Semana del Año (1–53)
        </label>
        <input name="semana" type="number" min="1" max="53" required
               class="w-full bg-jj-light text-black rounded-md px-3 py-2 focus:outline-none"/>
      </div>

      <div>
        <label class="block text-jj-light font-bold mb-1">Turno</label>
        <input name="turno" required
               class="w-full bg-jj-light text-black rounded-md px-3 py-2 focus:outline-none"/>
      </div>
      <div>
        <label class="block text-jj-light font-bold mb-1">Piezas</label>
        <input name="piezas" type="number" min="0" step="1"
               class="w-full bg-jj-light text-black rounded-md px-3 py-2 focus:outline-none"/>
      </div>

      <div class="md:col-span-2">
        <label class="block text-jj-light font-bold mb-1">
          Tiempo Muerto (min)
        </label>
        <input name="tiempo_muerto" type="number" min="0" step="0.1"
               class="w-full bg-jj-light text-black rounded-md px-3 py-2 focus:outline-none"
               placeholder="Opcional"/>
      </div>

      <div class="md:col-span-2 flex justify-center mt-4">
        <button type="submit"
                class="bg-red-600 text-white font-semibold rounded px-4 py-2 hover:bg-green-600 transition-colors duration-200">
          ENVIAR
        </button>
      </div>
    </form>
    <div id="msg" class="mt-4 text-center text-sm text-red-600"></div>
  </div>

 <script>
   if (!localStorage.getItem('token')) {
    window.location.href = '/login.html';
  }
  // 1) Helper para obtener el header con JWT
  function getAuthHeaders() {
    const token = localStorage.getItem('token');
    return {
      'Content-Type':  'application/json',
      'Authorization': `Bearer ${token}`
    };
  }

  // 2) IIFE para el formulario
  (function(){
    const form = document.getElementById('efForm');
    const msg  = document.getElementById('msg');

    form.addEventListener('submit', async e => {
      e.preventDefault();

      // 2A) Recolectamos y normalizamos
      const raw = Object.fromEntries(new FormData(form).entries());
      const data = {
        ...raw,
        eficiencia_asociado: Number(raw.eficiencia_asociado),
        semana:              Number(raw.semana),
        piezas:              Number(raw.piezas || 0),
        tiempo_muerto:       raw.tiempo_muerto
                                ? Number(raw.tiempo_muerto)
                                : 0.0
      };

      try {
        // 2B) Petición POST con JWT en headers
        const res = await fetch('/api/eficiencias', {
          method:  'POST',
          headers: getAuthHeaders(),
          body:    JSON.stringify(data)
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(text);
        }

        // 2C) Éxito: mostramos mensaje, reseteamos y refrescamos todo
        msg.textContent = '✅ Registro guardado correctamente';
        form.reset();
        renderAll();  // <- refrésca tabla y gráficos
      } catch(err) {
        msg.textContent = '❌ Error: ' + err.message;
      }
    });
  })();
</script>
<script>
  const API_BASE = "";
  const TOKEN = localStorage.getItem("token");

  if (!TOKEN) {
    window.location.href = "/login.html";
  }

  // verifica rol admin (opcional, desde el frontend)
  (function checkAdminFrontend() {
    const role = localStorage.getItem("user_role") || "";
    if (role !== "admin") {
      alert("Esta página es solo para administradores.");
      window.location.href = "/";
    }
  })();

  async function crearRegistro(payload) {
    const res = await fetch(`${API_BASE}/api/eficiencias`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${TOKEN}`
      },
      body: JSON.stringify(payload)
    });

    if (res.status === 401) {
      localStorage.removeItem("token");
      window.location.href = "/login.html";
      return;
    }

    if (res.status === 403) {
      const msg = await res.text();
      alert("No tienes permisos de administrador.\n\n" + msg);
      return null;
    }

    if (!res.ok) {
      const txt = await res.text();
      alert("Error al crear registro:\n\n" + txt);
      return null;
    }

    return res.json();
  }

  function leerForm() {
    // Validaciones mínimas; ajusta según necesites
    const payload = {
      nombre_asociado: (document.getElementById("nombre_asociado")?.value || "").trim(),
      linea: (document.getElementById("linea")?.value || "").trim(),
      supervisor: (document.getElementById("supervisor")?.value || "").trim(),
      tipo_proceso: (document.getElementById("tipo_proceso")?.value || "").trim(), // "SW" o "WD"
      proceso: (document.getElementById("proceso")?.value || "").trim(),
      eficiencia_asociado: parseFloat(document.getElementById("eficiencia_asociado")?.value || "0"),
      semana: parseInt(document.getElementById("semana")?.value || "0", 10),
      turno: (document.getElementById("turno")?.value || "").trim(),
      piezas: parseInt(document.getElementById("piezas")?.value || "0", 10),
      tiempo_muerto: parseFloat(document.getElementById("tiempo_muerto")?.value || "0")
    };

    // Validaciones básicas
    if (!payload.nombre_asociado || !payload.linea || !payload.supervisor || !payload.tipo_proceso || !payload.proceso || !payload.turno) {
      alert("Completa los campos obligatorios.");
      return null;
    }
    if (!["SW", "WD"].includes(payload.tipo_proceso)) {
      alert("tipo_proceso debe ser SW o WD.");
      return null;
    }
    if (Number.isNaN(payload.semana) || payload.semana <= 0) {
      alert("Semana debe ser un entero mayor a 0.");
      return null;
    }
    if (Number.isNaN(payload.eficiencia_asociado)) payload.eficiencia_asociado = 0;
    if (Number.isNaN(payload.piezas)) payload.piezas = 0;
    if (Number.isNaN(payload.tiempo_muerto)) payload.tiempo_muerto = 0;

    return payload;
  }

  document.getElementById("btn-crear")?.addEventListener("click", async (ev) => {
    ev.preventDefault();
    const payload = leerForm();
    if (!payload) return;

    const creado = await crearRegistro(payload);
    if (creado) {
      alert("Registro creado con éxito (ID: " + creado.id + ").");
      // opcional: limpiar el formulario
      // document.querySelector("form")?.reset();
    }
  });
</script>


  
</body>
<!-- Footer -->
    <footer class="mt-12 text-center text-jj-light text-sm">
      <a href="#" class="underline mx-2">Privacy Policy</a>
      <a href="#" class="underline mx-2">Legal Notice</a><br/>
      &copy; Johnson &amp; Johnson, Inc. 2025
    </footer>
</html>
