<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard de Eficiencias</title>

  <!-- Redirecci√≥n si no hay token -->
  <script>
    if (!localStorage.getItem('token')) {
      window.location.href = '/login.html';
    }
    // Tailwind: configura ANTES del CDN
    window.tailwind = {
      config: {
        theme: {
          extend: {
            colors: {
              'jj-red':   '#E2231A',
              'jj-gray':  '#F5F5F5',
              'jj-dark':  '#333333',
              'jj-light': '#FFFFFF'
            },
            fontFamily: {
              sans: ['Source Sans Pro', 'ui-sans-serif', 'system-ui']
            }
          }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- CSS opcional -->
  <link rel="stylesheet" href="/static/style.css">
</head>
<body class="bg-jj-gray font-sans text-jj-dark min-h-screen">
  <div class="container mx-auto py-8 space-y-6">
    <!-- Header con filtros y bot√≥n Salir -->
    <header class="sticky top-0 z-20 bg-jj-light shadow-md rounded">
      <div class="container mx-auto px-4 py-3">
        <div class="flex flex-wrap items-end gap-4">
          <h1 class="text-xl font-bold mr-4">Johnson &amp; Johnson ‚Äì Dashboard S&amp;S</h1>

          <!-- Fecha Inicio -->
          <div class="flex flex-col">
            <label for="filterStart" class="text-sm font-medium text-jj-dark mb-1">Fecha Inicio</label>
            <input id="filterStart" type="date"
                   class="border border-gray-300 rounded-md px-3 py-2 focus:ring-jj-red focus:border-jj-red"/>
          </div>

          <!-- Fecha Fin -->
          <div class="flex flex-col">
            <label for="filterEnd" class="text-sm font-medium text-jj-dark mb-1">Fecha Fin</label>
            <input id="filterEnd" type="date"
                   class="border border-gray-300 rounded-md px-3 py-2 focus:ring-jj-red focus:border-jj-red"/>
          </div>

          <!-- L√≠nea -->
          <div class="flex flex-col">
            <label for="filterLinea" class="text-sm font-medium text-jj-dark mb-1">L√≠nea</label>
            <select id="filterLinea"
                    class="border border-gray-300 rounded-md px-3 py-2 focus:ring-jj-red focus:border-jj-red">
              <option value="">-- Todas --</option>
            </select>
          </div>

          <!-- Proceso -->
          <div class="flex flex-col">
            <label for="filterProceso" class="text-sm font-medium text-jj-dark mb-1">Proceso</label>
            <select id="filterProceso"
                    class="border border-gray-300 rounded-md px-3 py-2 focus:ring-jj-red focus:border-jj-red">
              <option value="">-- Todos --</option>
            </select>
          </div>

          <!-- Acciones -->
          <div class="ml-auto flex items-center gap-3">
            <button id="applyFilters"
                    class="bg-red-600 text-white font-semibold rounded px-4 py-2 hover:bg-green-600 transition-colors duration-200">
              Aplicar filtros
            </button>

            <button id="btn-logout"
                    class="bg-gray-200 text-jj-dark font-semibold rounded px-4 py-2 hover:bg-gray-300 transition-colors duration-200">
              Salir
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- KPIs -->
    <section>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-jj-light p-4 rounded-lg shadow flex flex-col items-center">
          <span class="text-sm text-gray-500">Total de Registros</span>
          <span class="text-3xl font-bold" id="kpi-total-records">0</span>
        </div>
        <div class="bg-jj-light p-4 rounded-lg shadow flex flex-col items-center">
          <span class="text-sm text-gray-500">Eficiencia Promedio</span>
          <span class="text-3xl font-bold" id="kpi-average-efficiency">0%</span>
        </div>
        <div class="bg-jj-light p-4 rounded-lg shadow flex flex-col items-center">
          <span class="text-sm text-gray-500">Mejor L√≠nea</span>
          <span class="text-3xl font-bold" id="kpi-best-line">‚Äî</span>
        </div>
        <div class="bg-jj-light p-4 rounded-lg shadow flex flex-col items-center">
          <span class="text-sm text-gray-500">Tiempo Muerto Semanal</span>
          <span class="text-3xl font-bold" id="kpi-downtime">0 min</span>
        </div>
      </div>
    </section>

    <!-- Subir Excel -->
    <section class="bg-jj-light p-4 rounded-lg shadow">
      <form id="uploadForm" class="flex items-center gap-4" enctype="multipart/form-data">
        <input id="fileInput" type="file" accept=".xls,.xlsx"
               class="border border-gray-300 rounded px-3 py-2 bg-white" />
        <button type="submit"
                class="bg-red-600 text-white font-semibold rounded px-4 py-2 hover:bg-green-600 transition-colors duration-200">
          üìÇ Subir Excel
        </button>
        <span id="uploadMsg" class="text-sm"></span>
      </form>
    </section>

    <!-- Gr√°ficas -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <div class="bg-jj-light p-4 rounded-lg shadow">
        <h3 class="font-semibold mb-2">Eficiencia Semanal por Proceso</h3>
        <canvas id="weeklyChart" width="800" height="300"></canvas>
      </div>
      <div class="bg-jj-light p-4 rounded-lg shadow">
        <h3 class="font-semibold mb-2">Eficiencia Diaria por Proceso</h3>
        <canvas id="dailyProcessChart" width="800" height="300"></canvas>
      </div>
      <div class="bg-jj-light p-4 rounded-lg shadow">
        <h3 class="font-semibold mb-2">Eficiencia Diaria por L√≠nea</h3>
        <canvas id="dailyLineChart" width="800" height="300"></canvas>
      </div>
      <div class="bg-jj-light p-4 rounded-lg shadow">
        <h3 class="font-semibold mb-2">Top 5 Peores Asociados</h3>
        <canvas id="topAssocChart" width="800" height="300"></canvas>
      </div>
      <div class="bg-jj-light p-4 rounded-lg shadow">
        <h3 class="font-semibold mb-2">Eficiencia Promedio por Turno</h3>
        <canvas id="shiftChart" width="800" height="300"></canvas>
      </div>
      <div class="bg-jj-light p-4 rounded-lg shadow">
        <h3 class="font-semibold mb-2">Conteo de SW vs WD por L√≠nea</h3>
        <canvas id="countChart" width="800" height="300"></canvas>
      </div>
      <div class="bg-jj-light p-4 rounded-lg shadow">
        <h3 class="font-semibold mb-2">Tiempo Muerto Semanal por L√≠nea</h3>
        <canvas id="downtimeChart" width="800" height="300"></canvas>
      </div>
    </section>

    <!-- Tabla -->
    <section class="bg-jj-light p-4 rounded-lg shadow">
      <h2 class="font-semibold mb-3">Registros Recientes</h2>
      <div class="overflow-auto">
        <table id="efTable" class="min-w-full text-sm">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2 pr-3">Asociado</th>
              <th class="py-2 pr-3">L√≠nea</th>
              <th class="py-2 pr-3">Supervisor</th>
              <th class="py-2 pr-3">Tipo</th>
              <th class="py-2 pr-3">Proceso</th>
              <th class="py-2 pr-3">Efic. Asociado</th>
              <th class="py-2 pr-3">Semana</th>
              <th class="py-2 pr-3">Turno</th>
              <th class="py-2 pr-3">Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- ======= SCRIPTS ======= -->
  <script>
 
    const PALETTE = ['#2563eb', '#dc2626', '#f59e0b', '#10b981', '#7c3aed', '#0d9488', '#f43f5e', '#6366f1'];

    function minutesToHours(mins) {
      return (Number(mins || 0) / 60).toFixed(2); // horas con 2 decimales
    }


    function getAuthHeaders() {
      const token = localStorage.getItem('token');
      return { 'Authorization': `Bearer ${token}` };
    }

    // Logout
    document.getElementById('btn-logout')?.addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('user_email');
      localStorage.removeItem('user_role');
      window.location.href = '/login.html';
    });

    // --------- Subida Excel ----------
    document.getElementById('uploadForm').addEventListener('submit', async e => {
      e.preventDefault();
      const file = document.getElementById('fileInput').files[0];
      const msg  = document.getElementById('uploadMsg');
      if (!file) {
        msg.textContent = 'Selecciona un archivo primero';
        return;
      }
      const fd = new FormData();
      fd.append('file', file);
      try {
        const res = await fetch('/api/eficiencias/upload', {
          method: 'POST',
          headers: getAuthHeaders(), // solo auth; FormData pone boundary
          body: fd
        });
        if (!res.ok) throw await res.text();
        const data = await res.json();
        msg.textContent = `‚úÖ Insertados ${data.insertados} registros`;
        // refresca opciones (por si aparecieron nuevas l√≠neas/procesos) y re-renderiza
        await loadFilterOptions(true);
        await renderAll();
      } catch (err) {
        msg.textContent = '‚ùå Error: ' + err;
      }
    });

    // --------- Helpers ----------
       // --- Formatea minutos a "X h Y min"
   function formatMinutes(mins) {
  const m = Math.round(Number(mins || 0));
  if (m < 60) return `${m} min`;
  const h = Math.floor(m / 60);
  const r = m % 60;
  return r === 0 ? `${h} h` : `${h} h ${r} min`;
}

    function createChart(id, cfg) {
      const canvas = document.getElementById(id);
      const old = Chart.getChart(canvas);
      if (old) old.destroy();
      return new Chart(canvas, cfg);
    }

    async function safeRender(fn) {
      try { await fn(); } catch (e) { console.error(`Error en ${fn.name}:`, e); }
    }

    function getFilterQS() {
      const params = new URLSearchParams();
      const s = document.getElementById('filterStart').value;
      const e = document.getElementById('filterEnd').value;
      const l = document.getElementById('filterLinea').value;
      const p = document.getElementById('filterProceso').value;
      if (s) params.append('start', s);
      if (e) params.append('end',   e);
      if (l) params.append('linea', l);
      if (p) params.append('proceso', p);
      const qs = params.toString();
      return qs ? '?' + qs : '';
    }

    // Carga opciones 1 sola vez, y conserva selecci√≥n si se llama de nuevo.
    async function loadFilterOptions(force = false) {
      const lineaSel  = document.getElementById('filterLinea');
      const procesoSel = document.getElementById('filterProceso');

      const prevLinea = lineaSel.value;
      const prevProc  = procesoSel.value;

      // Si no es force y ya hay m√°s de la opci√≥n por defecto, no repoblar
      if (!force && lineaSel.options.length > 1 && procesoSel.options.length > 1) return;

      lineaSel.innerHTML   = '<option value="">-- Todas --</option>';
      procesoSel.innerHTML = '<option value="">-- Todos --</option>';

      const headers = getAuthHeaders();

      let lines = [];
      let procs = [];
      try {
        const [r1, r2] = await Promise.all([
          fetch('/api/eficiencias/lines', { headers }),
          fetch('/api/eficiencias/processes', { headers })
        ]);
        if (r1.ok) lines = await r1.json();
        if (r2.ok) procs = await r2.json();
      } catch (_) {}

      // Fallback si vienen vac√≠os
      if (!Array.isArray(lines) || !lines.length || !Array.isArray(procs) || !procs.length) {
        try {
          const r = await fetch('/api/eficiencias?limit=1000' + getFilterQS(), { headers });
          if (r.ok) {
            const data = await r.json();
            const setLineas   = new Set();
            const setProcesos = new Set();
            data.forEach(row => {
              if (row.linea)   setLineas.add(row.linea);
              if (row.proceso) setProcesos.add(row.proceso);
            });
            if (!lines.length) lines = [...setLineas].sort();
            if (!procs.length) procs = [...setProcesos].sort();
          }
        } catch (_) {}
      }

      (lines || []).forEach(l => {
        const o = document.createElement('option');
        o.value = l; o.textContent = l;
        lineaSel.appendChild(o);
      });
      (procs || []).forEach(p => {
        const o = document.createElement('option');
        o.value = p; o.textContent = p;
        procesoSel.appendChild(o);
      });

      // Restaura selecci√≥n si sigue disponible
      if ([...lineaSel.options].some(o => o.value === prevLinea)) lineaSel.value = prevLinea;
      if ([...procesoSel.options].some(o => o.value === prevProc)) procesoSel.value = prevProc;
    }

    // --------- Renders ----------
    async function renderKPIs() {
      const qs = getFilterQS();

      const res = await fetch('/api/eficiencias' + qs, { headers: getAuthHeaders() });
      if (!res.ok) return;
      const data = await res.json();

      const total = data.length;
      document.getElementById('kpi-total-records').textContent = total;

      const sumEff = data.reduce((sum, r) => sum + (r.eficiencia_asociado ?? 0), 0);
      const avgEff = total ? (sumEff / total).toFixed(1) + '%' : '0%';
      document.getElementById('kpi-average-efficiency').textContent = avgEff;

      const lineMap = {};
      data.forEach(r => (lineMap[r.linea] ||= []).push(r.eficiencia_asociado || 0));
      let bestLine = '‚Äî', bestAvg = -Infinity;
      for (const [line, arr] of Object.entries(lineMap)) {
        const avg = arr.reduce((a,b)=>a+b,0) / arr.length;
        if (avg > bestAvg) { bestAvg = avg; bestLine = line; }
      }
      document.getElementById('kpi-best-line').textContent = bestLine;

      const dtRes = await fetch('/api/eficiencias/weekly/downtime' + qs, { headers: getAuthHeaders() });
        if (dtRes.ok) {
      const dtData = await dtRes.json();
        if (dtData.length) {
      const maxSemana = Math.max(...dtData.map(r => r.semana));
      const recs = dtData.filter(r => r.semana === maxSemana);
      const totalDow = recs.reduce((s,r)=> s + (r.total_downtime || 0), 0);  // ‚Üê usa total_downtime
      document.getElementById('kpi-downtime').textContent = formatMinutes(totalDow);
          } else {
       document.getElementById('kpi-downtime').textContent = '0 min';
          }
      }



      }

    async function renderDashboard() {
      const res = await fetch('/api/eficiencias' + getFilterQS(), { headers: getAuthHeaders() });
      if (!res.ok) { console.error('Error eficiencias:', await res.text()); return; }
      const data = await res.json();

      const tbody = document.querySelector('#efTable tbody');
      tbody.innerHTML = '';
      data.forEach(r => {
        const tr = document.createElement('tr');
        tr.className = 'border-b';
        tr.innerHTML = `
          <td class="py-2 pr-3">${r.nombre_asociado}</td>
          <td class="py-2 pr-3">${r.linea}</td>
          <td class="py-2 pr-3">${r.supervisor}</td>
          <td class="py-2 pr-3">${r.tipo_proceso}</td>
          <td class="py-2 pr-3">${r.proceso}</td>
          <td class="py-2 pr-3">${Number(r.eficiencia_asociado).toFixed(1)}%</td>
          <td class="py-2 pr-3">${r.semana}</td>
          <td class="py-2 pr-3">${r.turno}</td>
          <td class="py-2 pr-3">
            <button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200"
                    onclick="borrarRegistro(${r.id}, this)">üóëÔ∏è</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    let weeklyChartInstance, dailyProcessChartInstance, dailyLineChartInstance, topAssocChartInstance, shiftChartInstance, countChartInstance, downtimeChartInstance;

    async function renderWeekly() {
      const res = await fetch('/api/eficiencias/weekly' + getFilterQS(), { headers: getAuthHeaders() });
      if (!res.ok) return;
      const raw = await res.json();

      if (!raw.length) {
        if (weeklyChartInstance) weeklyChartInstance.destroy();
        const ctx = document.getElementById('weeklyChart').getContext('2d');
        ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
        ctx.font = '14px sans-serif'; ctx.fillText('Sin datos para el filtro actual', 20, 30);
        return;
      }

      const procStats = {};
      raw.forEach(r => (procStats[r.proceso] ||= []).push(r.promedio_asociado));
      const ranked = Object.entries(procStats)
        .map(([p, arr]) => [p, arr.reduce((a,b)=>a+b,0)/arr.length])
        .sort((a,b)=>b[1]-a[1]);

      const TOP_N = 8;
      const topProcesos = ranked.slice(0, TOP_N).map(([p]) => p);
      const otherProcesos = ranked.slice(TOP_N).map(([p]) => p);
      const semanas = [...new Set(raw.map(r => r.semana))].sort((a,b)=>a-b);

      const datasets = topProcesos.map((proc, idx) => ({
        label: proc,
        data: semanas.map(sem => {
          const rec = raw.find(r => r.semana === sem && r.proceso === proc);
          return rec ? Number(rec.promedio_asociado.toFixed(1)) : 0;
        }),
        backgroundColor: PALETTE[idx % PALETTE.length],
        borderRadius: 4
      }));

      if (otherProcesos.length) {
        datasets.push({
          label: 'Otros',
          data: semanas.map(sem => {
            const subset = raw.filter(r => r.semana === sem && otherProcesos.includes(r.proceso));
            if (!subset.length) return 0;
            const avg = subset.reduce((s,r)=>s+r.promedio_asociado,0)/subset.length;
            return Number(avg.toFixed(1));
          }),
          backgroundColor: '#9ca3af',
          borderRadius: 4
        });
      }

      weeklyChartInstance = createChart('weeklyChart', {
        type: 'bar',
        data: { labels: semanas, datasets },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          plugins: { legend: { position: 'top' } },
          scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: 'Eficiencia (%)' } } }
        }
      });
    }

    async function renderDailyProcess() {
      const res = await fetch('/api/eficiencias/daily/process' + getFilterQS(), { headers: getAuthHeaders() });
      if (!res.ok) return;
      const raw = await res.json();

      if (!raw.length) {
        if (dailyProcessChartInstance) dailyProcessChartInstance.destroy();
        const ctx = document.getElementById('dailyProcessChart').getContext('2d');
        ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
        ctx.font = '14px sans-serif'; ctx.fillText('Sin datos para el filtro actual', 20, 30);
        return;
      }

      const procStats = {};
      raw.forEach(r => (procStats[r.proceso] ||= []).push(r.promedio_asociado));
      const ranked = Object.entries(procStats)
        .map(([p, arr]) => [p, arr.reduce((a,b)=>a+b,0)/arr.length])
        .sort((a,b)=>b[1]-a[1]);

      const TOP_N = 8;
      const topProcesos = ranked.slice(0, TOP_N).map(([p]) => p);
      const others = ranked.slice(TOP_N).map(([p]) => p);

      const fechas = [...new Set(raw.map(r => r.fecha))].sort();

      const datasets = topProcesos.map((proc, idx) => ({
        label: proc,
        data: fechas.map(f => {
          const rec = raw.find(r => r.fecha === f && r.proceso === proc);
          return rec ? Number(rec.promedio_asociado.toFixed(1)) : 0;
        }),
        backgroundColor: PALETTE[idx % PALETTE.length],
        borderRadius: 4
      }));

      if (others.length) {
        datasets.push({
          label: 'Otros',
          data: fechas.map(f => {
            const subset = raw.filter(r => r.fecha === f && others.includes(r.proceso));
            if (!subset.length) return 0;
            const avg = subset.reduce((s,r)=>s+r.promedio_asociado,0)/subset.length;
            return Number(avg.toFixed(1));
          }),
          backgroundColor: '#9ca3af',
          borderRadius: 4
        });
      }

      dailyProcessChartInstance = createChart('dailyProcessChart', {
        type: 'bar',
        data: { labels: fechas, datasets },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          plugins: { legend: { position: 'top' } },
          scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: 'Eficiencia (%)' } } }
        }
      });
    }

    async function renderDailyLine() {
      const res = await fetch('/api/eficiencias/daily/line' + getFilterQS(), { headers: getAuthHeaders() });
      if (!res.ok) return;
      const raw = await res.json();

      if (dailyLineChartInstance) dailyLineChartInstance.destroy();
      if (!raw.length) {
        const ctx = document.getElementById('dailyLineChart').getContext('2d');
        ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
        ctx.font = '14px sans-serif'; ctx.fillText('Sin datos para el filtro actual', 20, 30);
        return;
      }

      const fechas  = [...new Set(raw.map(r => r.fecha))].sort();
      const lineas  = [...new Set(raw.map(r => r.linea))];

      const datasets = lineas.map((linea, idx) => ({
        label: linea,
        data: fechas.map(f => {
          const rec = raw.find(r => r.fecha === f && r.linea === linea);
          return rec ? Number(rec.promedio_asociado.toFixed(1)) : 0;
        }),
        backgroundColor: PALETTE[idx % PALETTE.length],
        borderColor:     PALETTE[idx % PALETTE.length],
        fill: false,
        tension: 0.3,
        pointRadius: 3
      }));

      dailyLineChartInstance = createChart('dailyLineChart', {
        type: 'bar',
        data: { labels: fechas, datasets },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          plugins: { legend: { position: 'top' } },
          scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: 'Eficiencia (%)' } } }
        }
      });
    }

    async function renderTopAssociates() {
      const qs = getFilterQS();
      const sep = qs ? '&' : '?';
      const res = await fetch('/api/eficiencias/top-associates' + qs + sep + 'limit=5', { headers: getAuthHeaders() });
      if (!res.ok) return;
      const data = await res.json();

      const labels  = data.map(r => r.nombre);
      const valores = data.map(r => r.promedio_asociado);

      topAssocChartInstance = createChart('topAssocChart', {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: 'Eficiencia Asociado (%)', data: valores, backgroundColor: labels.map((_, i) => PALETTE[i % PALETTE.length]) }]
        },
        options: {
          scales: {
            y: { beginAtZero: true, max: 100, title: { display: true, text: '%' } },
            x: { ticks: { autoSkip: false } }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    async function renderShift() {
      const res = await fetch('/api/eficiencias/shift' + getFilterQS(), { headers: getAuthHeaders() });
      if (!res.ok) return;
      const data = await res.json();

      const labels  = data.map(r => r.turno);
      const valores = data.map(r => r.promedio_asociado);

      shiftChartInstance = createChart('shiftChart', {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: 'Eficiencia (%)', data: valores, backgroundColor: labels.map((_, i) => PALETTE[i % PALETTE.length]) }]
        },
        options: {
          scales: {
            y: { beginAtZero: true, max: 100, title: { display: true, text: '%' } },
            x: { title: { display: true, text: 'Turno' } }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    async function renderCounts() {
      const res = await fetch('/api/eficiencias/counts' + getFilterQS(), { headers: getAuthHeaders() });
      if (!res.ok) return;
      const data = await res.json();

      const lineas   = [...new Set(data.map(r => r.linea))];
      const swCounts = lineas.map(l => data.find(r => r.linea === l && r.tipo_proceso === 'SW')?.total_piezas || 0);
      const wdCounts = lineas.map(l => data.find(r => r.linea === l && r.tipo_proceso === 'WD')?.total_piezas || 0);

      countChartInstance = createChart('countChart', {
        type: 'bar',
        data: {
          labels: lineas,
          datasets: [
            { label: 'SW (piezas)', data: swCounts, backgroundColor: PALETTE[0] },
            { label: 'WD (piezas)', data: wdCounts, backgroundColor: PALETTE[1] }
          ]
        },
        options: {
          plugins: { legend: { position: 'top' } },
          scales: {
            x: { title: { display: true, text: 'L√≠nea' } },
            y: { beginAtZero: true, title: { display: true, text: 'Piezas' } }
          }
        }
      });
    }

  async function renderDowntime() {
  const res = await fetch('/api/eficiencias/weekly/downtime' + getFilterQS(), {
    headers: getAuthHeaders()
  });
  if (!res.ok) return;
  const raw = await res.json();

  if (downtimeChartInstance) downtimeChartInstance.destroy();
  if (!raw.length) {
    const ctx = document.getElementById('downtimeChart').getContext('2d');
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    ctx.font = '14px sans-serif';
    ctx.fillText('Sin datos para el filtro actual', 20, 30);
    return;
  }

  const semanas = [...new Set(raw.map(r => r.semana))].sort((a,b)=>a-b);
  const lineas  = [...new Set(raw.map(r => r.linea))];

  // Mant√©n los datos en MINUTOS
  const datasets = lineas.map((linea, idx) => ({
    label: linea,
    data: semanas.map(sem => {
      const rec  = raw.find(r => r.semana === sem && r.linea === linea);
      const mins = rec ? Number(rec.avg_downtime || 0) : 0;
      return Number(mins.toFixed(1)); // minutos
    }),
    backgroundColor: PALETTE[idx % PALETTE.length],
    borderColor:     PALETTE[idx % PALETTE.length],
  }));

  downtimeChartInstance = createChart('downtimeChart', {
    type: 'bar',
    data: { labels: semanas, datasets },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            // Muestra "X h Y min" o "Z min" seg√∫n aplique
            label: (item) => `${item.dataset.label}: ${formatMinutes(item.raw)}`
          }
        }
      },
      scales: {
        x: { title: { display: true, text: 'Semana' } },
        y: { beginAtZero: true, title: { display: true, text: 'Minutos' } }
      }
    }
  });
}


    // Borrar registro (solo admin)
    window.borrarRegistro = async function(id, btn) {
      if (!confirm('¬øEliminar registro #' + id + '?')) return;
      const res = await fetch('/api/eficiencias/' + id, {
        method: 'DELETE',
        headers: getAuthHeaders()
      });
      if (!res.ok) {
        alert('No se pudo eliminar: ' + (await res.text()));
        return;
      }
      const tr = btn.closest('tr');
      tr?.parentNode?.removeChild(tr);
    };

    async function renderAll() {
    await safeRender(renderDashboard);
    await safeRender(renderKPIs);
    await safeRender(renderWeekly);
    await safeRender(renderDailyProcess);
    await safeRender(renderDailyLine);
    await safeRender(renderTopAssociates);
    await safeRender(renderShift);
    await safeRender(renderCounts);
    await safeRender(renderDowntime);
  }

  // Init: pobla filtros una sola vez y render inicial
  window.addEventListener('DOMContentLoaded', async () => {
    await loadFilterOptions(true);           // carga opciones
    document.getElementById('applyFilters')
            .addEventListener('click', renderAll);  // aplica filtros solo al click
    await renderAll();                       // render inicial
  });
  </script>
</body>
</html>
