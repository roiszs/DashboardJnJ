<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Eficiencias</title>
  <!-- Chart.js desde CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f4f4f4; }
  </style>
</head>

<body>
     <!-- BotÃ³n para ir al formulario -->
  <button
    style="margin-bottom: 20px; padding: 8px 16px;"
    onclick="location.href='/add.html'"
  >
    âž• Agregar Registro
  </button>

  <h1>Dashboard de Eficiencias</h1>
  <canvas id="eficienciaChart" width="800" height="300"></canvas>
  <table id="efTable">
    <thead>
      <tr>
        <th>Asociado</th><th>WWID</th><th>LÃ­nea</th><th>Supervisor</th>
        <th>Tipo</th><th>Proceso</th><th>Batch</th>
        <th>Efic. Asociado</th><th>Efic. LÃ­nea</th><th>Fecha</th><th>Turno</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
  async function renderDashboard() {
    const res = await fetch('/api/eficiencias');
    const data = await res.json();

    // 1) Pinta la tabla
    const tbody = document.querySelector('#efTable tbody');
    data.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.nombre_asociado}</td>
        <td>${r.wwid}</td>
        <td>${r.linea}</td>
        <td>${r.supervisor}</td>
        <td>${r.tipo_proceso}</td>
        <td>${r.proceso}</td>
        <td>${r.numero_batch}</td>
        <td>${r.eficiencia_asociado.toFixed(1)}%</td>
        <td>${(r.eficiencia_linea||0).toFixed(1)}%</td>
        <td>${r.fecha}</td>
        <td>${r.turno}</td>
         <!-- AquÃ­ agrega: -->
    <td>
      <button onclick="borrarRegistro(${r.id}, this)">ðŸ—‘ Eliminar</button>
    </td>
      `;
      tbody.appendChild(tr);
    });

    // 2) Prepara datos para la grÃ¡fica (por lÃ­nea, promedio)
    const grouped = {};
    data.forEach(r => {
      if (!grouped[r.linea]) grouped[r.linea] = [];
      grouped[r.linea].push(r.eficiencia_asociado);
    });
    const labels = Object.keys(grouped);
    const avg = labels.map(l => (
      grouped[l].reduce((a,b)=>a+b,0)/grouped[l].length
    ));

    // 3) Dibuja el chart
    new Chart(document.getElementById('eficienciaChart'), {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Eficiencia Promedio por LÃ­nea (%)',
          data: avg
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true, max: 100 }
        }
      }
    });
  }
   async function borrarRegistro(id, btn) {
    if (!confirm("Â¿Seguro que quieres eliminar este registro?")) return;
    const res = await fetch(`/api/eficiencias/${id}`, { method: 'DELETE' });
    if (res.status === 204) {
      btn.closest('tr').remove();
    } else {
      alert("Error al eliminar el registro");
    }
  } 
  
  window.onload = renderDashboard;
  </script>
</body>
</html>
